{% extends 'workhours/base.html' %}
{% load static %}

{% block body_header1_pre_title %}
                  <!-- Pre title -->
                  <a href="{% url 'workhours.team' pk=object.team_id %}"><span class="fe fe-chevron-left"></span></a>
{% endblock %}

{% block content %}
  {% if not object.is_closed %}
      <!-- Modal dialog -->
      <div class="modal fade" id="modal-dialog" tabindex="-1" role="dialog" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-body text-center p-5">
              <div class="spinner-border text-secondary mb-4" role="status" style="width:94px;height:94px;">
                <span class="sr-only">Loading...</span>
              </div>
              <h4 id="modal-result" class="mt-1 mb-4"></h4>
              <h4 id="modal-step-title" class="mt-1 mb-4"></h4>
              <div class="progress progress-sm">
                <div id="modal-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                  aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                  style="width: 0"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
  {% endif %}
  {% for day in days %}
      <!-- Accordion for day {{ day.0 }} -->
      <div class="card">
        <h2 class="card-header">
          <span>
            <a class="card-link" data-toggle="collapse" href="#collapse-{{ day.0 }}" aria-expanded="true">
              {{ day.1 | date:date_format_full }}
            </a>
          </span>
    {% if not object.is_closed %}
          <input class="btn btn-primary save-button" type="button" value="Save daily data"
            id="save-{{ shift.pk }}" data-shifts="{{ day.3 }}" data-toggle="modal" data-target="#modal-dialog">
    {% endif %}
        </h2>
        <div id="collapse-{{ day.0 }}" class="collapse show">
          <div class="card-body">
            <div class="row card-row card-row-header">
              <div class="col-sm-3">Name</div>
              <div class="col-sm-2">Present</div>
              <div class="col-sm-2">Holiday</div>
              <div class="col-sm-2">Permit hours</div>
            </div>
    {% for shift in day.2 %}
            <div class="row card-row {% if forloop.counter|divisibleby:2 %}card-row-alternate{% endif %}">
              <div class="col-sm-3 shift-employee-name" id="employee-{{ shift.pk }}"
                data-date="{{ day.1 | date:date_format_full }}">{{ shift.employee }}</div>
              <div class="col-sm-2">
                <label>
                  <input class="zoom-x15" type="checkbox"{% if shift.is_present %} checked{% endif %}
                    id="present-{{ shift.pk }}">
                  &nbsp;&nbsp;Present
                </label>
              </div>
              <div class="col-sm-2">
                <label>
                  <input class="zoom-x15" type="checkbox"{% if shift.is_holiday %} checked{% endif %}
                    id="holiday-{{ shift.pk }}">
                  &nbsp;&nbsp;Holiday
                </label>
              </div>
              <div class="col-sm-2">
                <input class="zoom-x12" type="number" min="0" max="8" size="4" value="{{ shift.permit_hours }}"
                  id="permit-{{ shift.pk }}">
              </div>
            </div>
    {% endfor %}
          </div>
        </div>
      </div>
  {% endfor %}
{% endblock %}

{% block footer_js %}
  {{ block.super }}
  {% if not object.is_closed %}
    <script>
      // Save daily results
      $(".save-button").click(function() {
        let data = $(this).data("shifts");
        update_shifts(data);
      });
      // Update data using the modal dialog
      function update_shifts(data) {
        $("#modal-progress-bar").css("width", "0%");
        $("#modal-dialog").modal('show');
        let step_size_percent = 1 / data.length * 100;
        let step_width = 0;
        // Loop over each shift
        data.every(function (shift_id) {
          let employee = $("#employee-" + shift_id).text();
          let date = $("#employee-" + shift_id).data("date");
          let is_present = $("#present-" + shift_id).prop("checked");
          let is_holiday = $("#holiday-" + shift_id).prop("checked");
          let permit = $("#permit-" + shift_id).val();
          let update_status = false;
          console.log(shift_id, employee, date, is_present, is_holiday, permit);
          step_width += step_size_percent;
          $("#modal-step-title").text(employee);
          $("#modal-progress-bar").css("width", step_width + "%");
          $("#modal-result").text("Saving data for " + date);
          $.ajax({
              method: "POST",
              dataType: "json",
              url: "{% url 'workhours.shift' %}",
              data: {
                pk: shift_id,
                present: is_present,
                holiday: is_holiday,
                permit: permit,
                csrfmiddlewaretoken: '{{ csrf_token }}'
              },
              async: false,
              success: function () {
                console.log('success');
                update_status = true;
              },
              error: function () {
                console.log('fail');
                $("#modal-result").text("Unable to update");
              }
          });
          // Returning true the every() method processes the next iteration
          return update_status;
        });
        $('#modal-dialog').modal('hide');
      }
    </script>
  {% endif %}
{% endblock %}}