{% extends 'workhours/base.html' %}
{% load static %}
{% load i18n %}

{% block body_header1_pre_title %}
                  <!-- Pre title -->
                  <a href="{% url 'workhours.team' pk=object.team_id %}"><span class="fe fe-chevron-left"></span></a>
{% endblock %}

{% block content %}
  {% if not object.is_closed %}
      <!-- Modal dialog -->
      <div class="modal fade" id="modal-dialog" tabindex="-1" role="dialog" aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-body text-center p-5">
              <div class="spinner-border text-secondary mb-4" role="status" style="width:94px;height:94px;">
                <span class="sr-only">{% translate 'Loading...' context 'Week' %}</span>
              </div>
              <h4 id="modal-result" class="mt-1 mb-4"></h4>
              <h4 id="modal-step-title" class="mt-1 mb-4"></h4>
              <div class="progress progress-sm">
                <div id="modal-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                  aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"
                  style="width: 0"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
  {% endif %}
      <!-- Confirmation dialog -->
      <div class="modal fade" id="confirmation-dialog" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-sm modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title" id="confirmation-dialog-label">{% translate 'Confirm?' context 'Week' %}</h4>
              <button type="button" class="close" data-dismiss="modal" aria-label="{% translate 'Close' context 'Week' %}">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <p id="confirmation-dialog-text">
  {% if object.is_closed %}
                  {% translate 'Are you sure you want to reopen the closed week?' context 'Week' %}
  {% else %}
                  {% translate 'Are you sure you want to save the data and close the week?' context 'Week' %}
  {% endif %}
              </p>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-danger" id="confirmation-dialog-yes">
  {% if object.is_closed %}
                {% translate 'Reopen the week' context 'Week' %}
  {% else %}
                {% translate 'Close the week' context 'Week' %}
  {% endif %}
              </button>
              <button type="button" class="btn btn-primary" id="confirmation-dialog-no" data-dismiss="modal">
                {% translate 'Cancel' context 'Week' %}
              </button>
            </div>
          </div>
        </div>
      </div>
      <!-- Week details -->
      <div class="card">
        <h2 class="card-header">
          <span>
            <a class="card-link" data-toggle="collapse" href="#collapse-week" aria-expanded="true">
                {% translate 'Week details' context 'Week' %}
            </a>
          </span>
  {% if not object.is_closed %}
          <input class="btn btn-danger" type="button" value="{% translate 'Save all data and close the week' context 'Week' %}"
            id="week-save" data-toggle="modal" data-target="#confirmation-dialog">
  {% elif perms.workhours.can_reopen_weeks %}
          <input class="btn btn-danger" type="button" value="{% translate 'Reopen the week' context 'Week' %}"
            id="week-open" data-toggle="modal" data-target="#confirmation-dialog">
  {% endif %}
        </h2>
        <div id="collapse-week" class="collapse show">
          <div class="card-body">
            <div class="row card-row">
              <div class="col-sm-1">{% translate 'Status' context 'Week' %}</div>
              <div class="col-sm-9">
  {% if object.is_closed %}
                <span class="fe fe-lock"></span>
  {% else %}
                <span class="fe fe-check-circle"></span>
  {% endif %}
                {{ week_status }}
              </div>
            </div>
            <div class="row card-row">
              <div class="col-sm-1">
                <label for="notes">{% translate 'Notes' context 'Week' %}</label>
              </div>
  {% if not object.is_closed %}
              <div class="col-sm">
                <input type="text" id="notes" name="notes" value="{{ object.notes }}" class="form-control">
              </div>
  {% else %}
              <div class="col-sm-9">{{ object.notes }}</div>
  {% endif %}
            </div>
          </div>
        </div>
      </div>
  {% for day in days %}
      <!-- Accordion for day {{ day.0 }} -->
      <div class="card">
        <h2 class="card-header">
          <span>
            <a class="card-link" data-toggle="collapse" href="#collapse-{{ day.0 }}" aria-expanded="true">
              {{ day.1 | date:date_format_full }}
            </a>
          </span>
    {% if not object.is_closed %}
          <input class="btn btn-primary save-daily" type="button" value="{% translate 'Save daily data' context 'Week' %}"
            id="save-{{ shift.pk }}" data-shifts="{{ day.3 }}" data-toggle="modal" data-target="#modal-dialog">
    {% endif %}
        </h2>
        <div id="collapse-{{ day.0 }}" class="collapse show">
          <div class="card-body">
            <div class="row card-row card-row-header">
              <div class="col-sm-3">{% translate 'Name' context 'Shift' %}</div>
              <div class="col-sm-2">{% translate 'Is present' context 'Shift' %}</div>
              <div class="col-sm-2">{% translate 'Is holiday' context 'Shift' %}</div>
              <div class="col-sm-2">{% translate 'Permit hours' context 'Shift' %}</div>
            </div>
    {% for shift in day.2 %}
            <div class="row card-row {% if forloop.counter|divisibleby:2 %}card-row-alternate{% endif %}">
              <div class="col-sm-3 shift-employee-name" id="employee-{{ shift.pk }}"
                data-date="{{ day.1 | date:date_format_full }}">{{ shift.employee }}</div>
              <div class="col-sm-2">
                <label>
                  <input class="zoom-x15" type="checkbox"
                    {% if shift.is_present %} checked{% endif %}
                    {% if object.is_closed %} disabled{% endif %}
                    id="present-{{ shift.pk }}">
                  &nbsp;&nbsp;{% translate 'Is present' context 'Shift' %}
                </label>
              </div>
              <div class="col-sm-2">
                <label>
                  <input class="zoom-x15" type="checkbox"
                    {% if shift.is_holiday %} checked{% endif %}
                    {% if object.is_closed %} disabled{% endif %}
                    id="holiday-{{ shift.pk }}">
                  &nbsp;&nbsp;{% translate 'Is holiday' context 'Shift' %}
                </label>
              </div>
              <div class="col-sm-2">
                <input class="zoom-x12" type="number" min="0" max="8" size="4"
                  value="{{ shift.permit_hours }}"
                  {% if object.is_closed %} disabled{% endif %}
                  id="permit-{{ shift.pk }}">
              </div>
            </div>
    {% endfor %}
          </div>
        </div>
      </div>
  {% endfor %}
{% endblock %}

{% block footer_js %}
  {{ block.super }}
    <script>
  {% if not object.is_closed %}
      // Save daily results
      $(".save-daily").click(function() {
        let data = $(this).data("shifts");
        update_shifts(data);
        setTimeout(hide_dialog, {{ delay_after_save_day }});
      });
      // Save weekly results (confirmation done)
      $("#confirmation-dialog-yes").click(function() {
        $("#confirmation-dialog").modal('hide');
        let data = [];
        $(".save-daily").each(function (index, object) {
          data = data.concat($(object).data("shifts"));
        });
        update_shifts(data);
        update_week();
        setTimeout(hide_dialog, {{ delay_after_save_week }});
      });
      // Update data using the modal dialog
      function update_shifts(data) {
        $("#modal-progress-bar").css("width", "0%");
        $("#modal-dialog").modal('show');
        let step_size_percent = 1 / data.length * 100;
        let step_width = 0;
        // Loop over each shift
        data.every(function (shift_id) {
          let employee = $("#employee-" + shift_id).text();
          let date = $("#employee-" + shift_id).data("date");
          let is_present = $("#present-" + shift_id).prop("checked");
          let is_holiday = $("#holiday-" + shift_id).prop("checked");
          let permit = $("#permit-" + shift_id).val();
          let update_status = false;
          console.log(shift_id, employee, date, is_present, is_holiday, permit);
          step_width += step_size_percent;
          $("#modal-step-title").text(employee);
          $("#modal-progress-bar").css("width", step_width + "%");
          $("#modal-result").text('{% translate 'Saving data for ' context 'Week' %}' + date);
          $.ajax({
              method: "POST",
              dataType: "json",
              url: "{% url 'workhours.shift_update' %}",
              data: {
                pk: shift_id,
                present: is_present,
                holiday: is_holiday,
                permit: permit,
                csrfmiddlewaretoken: '{{ csrf_token }}'
              },
              async: false,
              success: function () {
                console.log('success');
                update_status = true;
              },
              error: function () {
                console.log('fail');
                $("#modal-result").text("{% translate 'Unable to update' context 'Week' %}");
              }
          });
          // Returning true the every() method processes the next iteration
          return update_status;
        });
      }
      // Update and close week
      function update_week() {
          let notes = $("#notes").val();
          $.ajax({
              method: "POST",
              dataType: "json",
              url: "{% url 'workhours.week.close' pk=object.pk %}",
              data: {
                notes: notes,
                csrfmiddlewaretoken: '{{ csrf_token }}'
              },
              async: false,
              success: function () {
                console.log('success');
                location.replace("{% url 'workhours.team' pk=object.team_id %}");
              },
              error: function () {
                console.log('fail');
                $("#modal-result").text("{% translate 'Unable to update' context 'Week' %}");
              }
          });
      }
  {% endif %}
  {% if object.is_closed and perms.workhours.can_reopen_weeks %}
      // Open closed week (confirmation done)
      $("#confirmation-dialog-yes").click(function() {
        $("#confirmation-dialog").modal('hide');
        $.ajax({
            method: "GET",
            url: "{% url 'workhours.week.open' pk=object.pk %}",
            async: false,
            success: function () {
              console.log('success');
              location.replace("{% url 'workhours.week' pk=object.pk %}");
            },
            error: function () {
              console.log('fail');
              $("#modal-result").text("{% translate 'Unable to update' context 'Week' %}");
            }
        });
        setTimeout(hide_dialog, {{ delay_after_save_week }});
      });
  {% endif %}
      // Hide the modal dialog
      function hide_dialog() {
        $('#modal-dialog').modal('hide');
      }
    </script>
{% endblock %}}